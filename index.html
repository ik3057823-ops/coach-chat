<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coach Chat — Vocabulary Practice</title>
  <style>
    :root{ --bg:#fff; --ink:#111827; --ink-dim:#6b7280; --brand:#2563eb; --soft:#f3f4f6; --soft-2:#e5e7eb; --radius:16px; --ok:#16a34a; --bad:#dc2626; }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:880px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid var(--soft-2);border-radius:var(--radius);box-shadow:0 6px 24px rgba(0,0,0,.05);overflow:hidden}
    .header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--soft-2)}
    .title{margin:0;font-weight:800;font-size:32px}
    .badge{font-size:12px;border-radius:999px;padding:2px 8px;color:#fff;margin-right:8px}
    .ok{background:var(--ok)} .bad{background:var(--bad)} .warn{background:#f59e0b}
    .progress{font-size:14px;color:var(--ink-dim)}
    .chat{height:min(60vh,560px);overflow:auto;padding:16px;background:var(--soft)}
    .bubble{max-width:78%;padding:12px 14px;border-radius:14px;margin:8px 0;line-height:1.35;font-size:15px;word-wrap:break-word}
    .bot{background:#fff;border:1px solid var(--soft-2);border-top-left-radius:4px}
    .user{background:var(--brand);color:#fff;border-top-right-radius:4px;margin-left:auto}
    .footer{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;border-top:1px solid var(--soft-2);background:#fff;font-size:13px;color:var(--ink-dim)}
    .inputbar{display:flex;gap:10px;padding:12px;border-top:1px solid var(--soft-2);background:#fff}
    .inputbar input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--soft-2);font-size:15px}
    .btn{appearance:none;border:1px solid var(--soft-2);background:var(--brand);color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .results{padding:28px;text-align:center}
    .hidden{display:none}
    @media (max-width:560px){ .chat{height:58vh} .bubble{max-width:86%} .title{font-size:24px} }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card" id="app">
    <div class="header">
      <h1 class="title">Coach Chat</h1>
      <div style="display:flex;align-items:center;gap:8px">
        <span id="api-status" class="badge warn">API: …</span>
        <span class="progress" id="progress">0 / 15</span>
      </div>
    </div>

    <div id="chat" class="chat" aria-live="polite" aria-label="Conversation"></div>

    <div class="footer">
      <div class="score" id="score">Correct: 0 • To review: 0</div>
      <div class="hint" id="hint">Tip: answer in one sentence. Use the word naturally.</div>
    </div>

    <div class="inputbar">
      <input id="msg" type="text" placeholder="Type your message…" autocomplete="off" />
      <button id="sendBtn" class="btn">Send</button>
    </div>
  </div>

  <div class="card results hidden" id="results">
    <div class="results">
      <h2>Session complete 🎉</h2>
      <p id="summary">You answered X correctly. Y queued for more practice.</p>
      <div style="display:flex;gap:12px;justify-content:center;margin-top:12px">
        <button id="reviewWrongBtn" class="btn" style="background:#6b7280;border-color:#6b7280">Practice missed ones</button>
        <button id="restartBtn" class="btn">Restart all</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  "use strict";

  // === Backend URL (change if your Vercel project name changes) ===
  const AI_API_URL = "https://coach-backend1.vercel.app/api/coach";

  // === Word list (with alternatives for acceptable variants) ===
  const WORDS = [
    { word:"diet", def:"The usual food and drink a person eats; also a controlled eating plan." },
    { word:"junk food", def:"Food high in sugar, salt, or fat and low in nutrients." },
    { word:"whole food", def:"Food that is minimally processed and close to its natural form." },
    { word:"food security", def:"Reliable access to enough safe and nutritious food to live a healthy life." },
    { word:"takeaway", def:"Food prepared by a restaurant to be eaten elsewhere (takeout).", alt:["take-out","take out","take away"] },
    { word:"processed", def:"Food changed from its natural state (e.g., adding salt, sugar, preservatives)." },
    { word:"perishable", def:"Food that spoils quickly without refrigeration." },
    { word:"wholesome", def:"Good for health; pure, simple, and nourishing." },
    { word:"organic", def:"Grown or made without most synthetic pesticides or fertilizers." },
    { word:"nutritious", def:"Nourishing; provides useful nutrients like vitamins and minerals." },
    { word:"consume", def:"To eat or drink; also to use up." },
    { word:"tempted", def:"Feeling a strong desire to do something you maybe shouldn't.", alt:["tempt"] },
    { word:"reduce", def:"To make smaller or less in amount, size, or number." },
    { word:"sample", def:"To try a small amount to test taste or quality." },
    { word:"digest", def:"To break down food in the body so it can be absorbed and used." }
  ];

  // === State ===
  let queue = [], wrongQueue = [], cur = null, task = null, attempts = 0;
  const MAX_ATTEMPTS = 2;
  let stats = { correct: 0, wrong: 0 }, history = [];

  // === DOM ===
  const $ = s => document.querySelector(s);
  const chat = $("#chat"), msg = $("#msg"), progress = $("#progress"), score = $("#score"),
        hint = $("#hint"), sendBtn = $("#sendBtn"), app = $("#app"), results = $("#results"),
        reviewWrongBtn = $("#reviewWrongBtn"), restartBtn = $("#restartBtn"), apiBadge = $("#api-status");

  // Show JS errors in the chat so nothing fails silently
  window.addEventListener("error", (e) => {
    const b = document.createElement("div"); b.className = "bubble bot";
    b.style.color = "#dc2626"; b.style.borderColor = "#dc2626";
    b.textContent = "Script error: " + (e.message || e.error || "Unknown");
    chat.appendChild(b);
  });

  // === Helpers ===
  function bubble(sender, text){
    const b = document.createElement("div");
    b.className = "bubble " + (sender === "bot" ? "bot" : "user");
    b.textContent = text;
    chat.appendChild(b);
    chat.scrollTop = chat.scrollHeight;
  }
  function shuffle(a){ a = a.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function setProgress(){
    const remaining = queue.length + (cur !== null ? 1 : 0);
    const completed = Math.max(WORDS.length - remaining, 0);
    progress.textContent = completed + " / " + WORDS.length;
    score.textContent = "Correct: " + stats.correct + " • To review: " + wrongQueue.length;
  }
  function presentTask(){
    const item = WORDS[cur];
    if (task === "sentence") {
      bubble("bot", 'Use "' + item.word + '" in a natural sentence.');
      hint.textContent = "Tip: mention the word directly in your sentence.";
    } else {
      bubble("bot", 'Which word matches this definition?\n"' + item.def + '"');
      hint.textContent = "Tip: answer with just the word/phrase.";
    }
  }
  function nextItem(){
    if (queue.length === 0) { endSession(); return; }
    cur = queue.shift();
    task = Math.random() < 0.55 ? "sentence" : "name";
    attempts = 0;
    setProgress(); presentTask();
  }
  function endSession(){
    window.__lastWrong = wrongQueue.slice();
    app.classList.add("hidden"); results.classList.remove("hidden");
    $("#summary").textContent = "You answered " + stats.correct + " correctly. " + wrongQueue.length + " queued for more practice.";
  }
  function startSession(onlyWrong=false){
    results.classList.add("hidden"); app.classList.remove("hidden"); chat.innerHTML = "";
    stats = { correct: 0, wrong: 0 }; wrongQueue = []; history = [];
    const all = WORDS.map((_,i)=>i);
    queue = (onlyWrong && window.__lastWrong?.length) ? window.__lastWrong.slice() : shuffle(all);
    cur = null; setProgress();
    bubble("bot", "Hi! I'm your coach. Let’s practice these words in a quick chat. Ready?");
    setTimeout(nextItem, 500);
  }

  // === Detect small talk/off-task messages ===
  function isSmallTalk(text){
    const t = text.trim().toLowerCase();
    if (!t) return false;
    if (/^(hi|hello|hey|yo|good (morning|afternoon|evening)|how (are|r) you|who are you|can you chat|talk to me|what can you do|ok|okay|cool|thanks?|thank you)$/.test(t)) return true;
    // very short questions often small talk
    if (t.endsWith("?") && t.split(/\s+/).length <= 8) return true;
    return false;
  }

  // === API calls ===
  async function callEval({task, item, user_input, history}){
    const payload = {
      mode: "eval",
      task,
      target: item.word,
      definition: item.def,
      alternatives: item.alt || [],
      user_input,
      history: history.slice(-6)
    };
    const res = await fetch(AI_API_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
    if(!res.ok) throw new Error("API error: " + res.status);
    const data = await res.json();
    if(!data || !data.verdict || !data.assistant) throw new Error("Malformed response from API");
    return data;
  }
  async function callChat({task, item, user_input, history}){
    const payload = {
      mode: "chat",
      task,
      target: item.word,
      definition: item.def,
      alternatives: item.alt || [],
      user_input,
      history: history.slice(-6)
    };
    const res = await fetch(AI_API_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
    if(!res.ok) throw new Error("API error: " + res.status);
    const data = await res.json();
    if(!data || !data.assistant) throw new Error("Malformed response from API");
    return data;
  }

  // === Send handler ===
  async function onSend(){
    const text = msg.value.trim();
    if (!text) return;

    // allow a quick "skip"
    const skip = /^(skip|pass|give up|idk|i don'?t know)$/i.test(text);

    msg.value = "";
    bubble("user", text);
    history.push({ role: "user", content: text });

    msg.disabled = true; sendBtn.disabled = true;

    // typing indicator
    const typing = document.createElement("div");
    typing.className = "bubble bot"; typing.textContent = "…";
    chat.appendChild(typing); chat.scrollTop = chat.scrollHeight;

    try{
      const item = WORDS[cur];
      if (!item) throw new Error("No current task yet — try again in a moment.");

      let result;

      if (isSmallTalk(text) && !skip) {
        // small talk: answer but keep current task
        result = await callChat({ task, item, user_input: text, history });
        typing.remove();
        bubble("bot", result.assistant);
        history.push({ role: "assistant", content: result.assistant });
        // do not advance or count attempts here
      } else {
        // evaluation path
        if (skip) { attempts = MAX_ATTEMPTS; } // force move on
        result = await callEval({ task, item, user_input: text, history });
        typing.remove();
        bubble("bot", result.assistant);
        history.push({ role: "assistant", content: result.assistant });

        if (result.verdict === "correct") {
          stats.correct++; cur = null; setProgress(); setTimeout(nextItem, 600);
        } else {
          attempts++;
          if (attempts < MAX_ATTEMPTS && !skip) {
            // stay on the same item; another try
            setProgress();
          } else {
            stats.wrong++; wrongQueue.push(cur);
            bubble("bot", "Let’s park this and try another. We’ll circle back later.");
            cur = null; setProgress(); setTimeout(nextItem, 600);
          }
        }
      }
    } catch (e) {
      typing.remove();
      console.error(e);
      bubble("bot", "⚠️ " + e.message);
    } finally {
      msg.disabled = false; sendBtn.disabled = false; msg.focus();
    }
  }

  // === Wire up ===
  sendBtn.addEventListener("click", onSend);
  msg.addEventListener("keydown", (e) => { if (e.key === "Enter") { e.preventDefault(); onSend(); } });
  reviewWrongBtn.addEventListener("click", () => startSession(true));
  restartBtn.addEventListener("click", () => startSession(false));

  // === API badge ===
  (async function ping(){
    try {
      const r = await fetch(AI_API_URL, { method: "OPTIONS" });
      if (r.ok) { apiBadge.textContent = "API: OK"; apiBadge.className = "badge ok"; }
      else { apiBadge.textContent = "API: " + r.status; apiBadge.className = "badge warn"; }
    } catch {
      apiBadge.textContent = "API: offline"; apiBadge.className = "badge bad";
    }
  })();

  // === Go! ===
  startSession();
});
</script>
</body>
</html>
