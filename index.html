<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Coach Chat ‚Äî Vocabulary Practice</title>
<style>
  :root{ --bg:#ffffff; --ink:#111827; --ink-dim:#6b7280; --brand:#2563eb; --ok:#16a34a; --bad:#dc2626; --soft:#f3f4f6; --soft-2:#e5e7eb; --radius:16px; }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:880px;width:100%;margin:0 auto;padding:16px}
  .card{background:#fff;border:1px solid var(--soft-2);border-radius:var(--radius);box-shadow:0 6px 24px rgba(0,0,0,.05);overflow:hidden}
  .header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--soft-2)}
  .title{font-size:18px;font-weight:700;margin:0}
  .progress{font-size:13px;color:var(--ink-dim)}
  .chat{height:min(60vh,560px);overflow:auto;padding:16px;background:var(--soft)}
  .bubble{max-width:78%; padding:12px 14px; border-radius:14px; margin:8px 0; line-height:1.35; font-size:15px; word-wrap:break-word;}
  .bot{background:#fff;border:1px solid var(--soft-2);border-top-left-radius:4px}
  .user{background:#2563eb;color:#fff;border-top-right-radius:4px;margin-left:auto}
  .inputbar{display:flex;gap:10px;padding:12px;border-top:1px solid var(--soft-2);background:#fff}
  .inputbar input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--soft-2);font-size:15px}
  .btn{appearance:none;border:1px solid var(--soft-2);background:#fff;color:#111827;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .footer{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;border-top:1px solid var(--soft-2);background:#fff}
  .hint{font-size:12px;color:#6b7280}
  .pill{font-size:12px;color:#fff;background:#0ea5e9;border-radius:999px;padding:4px 8px}
  .score{font-size:13px;color:#6b7280}
  .center{display:flex;gap:12px;justify-content:center;align-items:center}
  .results{padding:28px;text-align:center}
  .results h2{margin:0 0 8px}
  .results p{margin:6px 0;color:#6b7280}
  .hidden{display:none}
  @media (max-width:560px){ .chat{height:58vh} .bubble{max-width:86%} }
</style>
</head>
<body>
<div class="wrap">
  <div class="card" id="app">
    <div class="header">
      <h1 class="title">Coach Chat</h1>
      <div>
        <span class="pill" id="modePill">Practice</span>
        <span class="progress" id="progress">0 / 15</span>
      </div>
    </div>

    <div id="chat" class="chat" aria-live="polite" aria-label="Conversation"></div>

    <div class="footer">
      <div class="score" id="score">Correct: 0 ‚Ä¢ To review: 0</div>
      <div class="hint" id="hint">Tip: answer in one sentence. Use the word naturally.</div>
    </div>

    <div class="inputbar">
      <input id="msg" type="text" placeholder="Type your message‚Ä¶" autocomplete="off" />
      <button id="sendBtn" class="btn primary">Send</button>
    </div>
  </div>

  <div class="card results hidden" id="results">
    <div class="results">
      <h2>Session complete üéâ</h2>
      <p id="summary">You answered X correctly and Y were queued for review.</p>
      <div class="center" style="margin-top:12px">
        <button id="reviewWrongBtn" class="btn">Practice only the missed ones</button>
        <button id="restartBtn" class="btn primary">Restart all</button>
      </div>
    </div>
  </div>
</div>

<script>
/* 1) Backend URL */
const AI_API_URL = "https://coach-backend1.vercel.app/api/coach";

/* 2) Word list */
const WORDS = [
  { word:"diet", def:"The usual food and drink a person eats; also a controlled eating plan." },
  { word:"junk food", def:"Food high in sugar, salt, or fat and low in nutrients." },
  { word:"whole food", def:"Food that is minimally processed and close to its natural form." },
  { word:"food security", def:"Reliable access to enough safe and nutritious food to live a healthy life." },
  { word:"takeaway", def:"Food prepared by a restaurant to be eaten elsewhere (takeout).", alt:["take-out","take out","take away"] },
  { word:"processed", def:"Food changed from its natural state (e.g., adding salt, sugar, preservatives)." },
  { word:"perishable", def:"Food that spoils quickly without refrigeration." },
  { word:"wholesome", def:"Good for health; pure, simple, and nourishing." },
  { word:"organic", def:"Grown or made without most synthetic pesticides or fertilizers." },
  { word:"nutritious", def:"Nourishing; provides useful nutrients like vitamins and minerals." },
  { word:"consume", def:"To eat or drink; also to use up." },
  { word:"tempted", def:"Feeling a strong desire to do something you maybe shouldn‚Äôt.", base:"tempt" },
  { word:"reduce", def:"To make smaller or less in amount, size, or number." },
  { word:"sample", def:"To try a small amount to test taste or quality." },
  { word:"digest", def:"To break down food in the body so it can be absorbed and used." }
];
const TASKS = ["sentence","name"];

/* 3) State & DOM */
let queue=[], wrongQueue=[], cur=null, task=null;
let stats={correct:0, wrong:0}, history=[];
const $=s=>document.querySelector(s);
const app=$("#app"), results=$("#results"), chat=$("#chat");
const msg=$("#msg"), progress=$("#progress"), score=$("#score"), hint=$("#hint");

/* 4) Helpers */
function shuffle(a){ a=a.slice(); for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function bubble(sender,text){ const b=document.createElement("div"); b.className="bubble "+(sender==="bot"?"bot":"user"); b.textContent=text; chat.appendChild(b); chat.scrollTop=chat.scrollHeight; }

/* 5) API */
async function callAI({task,item,user_input,history}){
  const payload={
    system: `
You are a friendly ESL vocabulary coach. Keep replies brief (1‚Äì2 sentences).
Return strict JSON only: {"assistant":"...","verdict":"correct|incorrect|unsure","explanation":"..."}.
Tasks:
1) "sentence": Check if the learner used the target word/phrase naturally in one sentence. Allow inflections. If missing or misused, say why briefly and offer a short better example.
2) "name": Given a definition, check if their answer exactly matches the target word/phrase (accept minor spacing/hyphen variants if meaning is the same).
`.trim(),
    task, target:item.word, definition:item.def,
    user_input, history: history.slice(-6)
  };
  const res = await fetch(AI_API_URL, {
    method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload)
  });
  if(!res.ok) throw new Error("API error: "+res.status);
  const data = await res.json();
  if(!data || !data.verdict || !data.assistant) throw new Error("Malformed response");
  return data;
}

/* 6) Flow */
function setProgress(){
  const completed = (WORDS.length - (queue.length + (cur!==null?1:0)));
  progress.textContent = `${Math.max(completed,0)} / ${WORDS.length}`;
  score.textContent = `Correct: ${stats.correct} ‚Ä¢ To review: ${wrongQueue.length}`;
}
function presentTask(){
  const item=WORDS[cur];
  if(task==="sentence"){ bubble("bot",`Use ‚Äú${item.word}‚Äù in a natural sentence.`); hint.textContent="Tip: mention the word directly in your sentence."; }
  else{ bubble("bot",`Which word matches this definition?\n‚Äú${item.def}‚Äù`); hint.textContent="Tip: answer with just the word/phrase."; }
}
function nextItem(){
  if(queue.length===0){ endSession(); return; }
  cur=queue.shift(); task=Math.random()<0.55?"sentence":"name";
  setProgress(); presentTask();
}
function endSession(){
  window.__lastWrong = wrongQueue.slice();
  app.classList.add("hidden"); results.classList.remove("hidden");
  $("#summary").textContent = `You answered ${stats.correct} correctly. ${wrongQueue.length} queued for more practice.`;
}
function startSession(onlyWrong=false){
  results.classList.add("hidden"); app.classList.remove("hidden"); chat.innerHTML="";
  stats={correct:0,wrong:0}; wrongQueue=[]; history=[];
  const all = WORDS.map((_,i)=>i);
  queue = onlyWrong ? (window.__lastWrong?.length ? window.__lastWrong.slice() : all.slice()) : shuffle(all);
  cur=null; setProgress();
  bubble("bot","Hi! I‚Äôm your coach. Let‚Äôs practice these words in a quick chat. Ready?");
  setTimeout(nextItem,500);
}

/* 7) Handlers */
async function onSend(){
  const text=msg.value.trim(); if(!text) return;
  msg.value=""; bubble("user",text); history.push({role:"user",content:text});
  try{
    const item=WORDS[cur];
    const result=await callAI({task,item,user_input:text,history});
    bubble("bot",result.assistant); history.push({role:"assistant",content:result.assistant});
    if(result.verdict==="correct") stats.correct++; else { stats.wrong++; wrongQueue.push(cur); }
    cur=null; setProgress(); setTimeout(nextItem,800);
  }catch(e){
    console.error(e); bubble("bot","‚ö†Ô∏è Couldn‚Äôt reach the coach just now. Please try again.");
  }
}
$("#sendBtn").addEventListener("click", onSend);
msg.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); onSend(); } });

/* 8) Session controls on results screen */
$("#reviewWrongBtn").addEventListener("click", ()=> startSession(true));
$("#restartBtn").addEventListener("click", ()=> startSession(false));

/* 9) Init */
startSession();
</script>
</body>
</html>
